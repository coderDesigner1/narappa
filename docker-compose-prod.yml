services:
  narappa-db:
    image: yobasystems/alpine-mariadb:latest
    container_name: narappa-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - /home/ren/drives/stuff/narappa/db:/var/lib/mysql
      - ./db/dbscript.sql:/docker-entrypoint-initdb.d/01-data.sql
    healthcheck:
      test: ["CMD-SHELL", "mysql -uroot -p$$MYSQL_ROOT_PASSWORD -e 'SELECT 1' 2>/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  narappa-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: narappa-backend
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://narappa-db:3306/${MYSQL_DATABASE}?createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&useSSL=false
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      FILE_UPLOAD_DIR: ${FILE_UPLOAD_DIR}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      narappa-db:
        condition: service_healthy

  narappa-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: narappa-frontend
    restart: unless-stopped
    depends_on:
      - narappa-backend

networks:
  default:
    external: true
    name: main